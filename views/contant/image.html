<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="UTF-8">
  <title>عرض صورة الكورس</title>
  <link rel="stylesheet" href="image.css">
  <link rel="stylesheet" href="/home/Course.css">
  <script src="https://kit.fontawesome.com/your-fontawesome-kit.js" crossorigin="anonymous"></script>
</head>
<body>
    <style>
          .contant{
    margin: auto;
    box-shadow: 3px 5px 5px 3px rgb(212 212 212) !important;
  }
  .contant-div{
    box-shadow: 3px 5px 5px 3px rgb(212 212 212);
  }
  .contant-div p{
    direction: rtl;
    align-self: center;
  }
    </style>
  <div id="header"></div>

  <div id="image-title"></div>
  <div id="image-box" style="text-align:center; margin:20px 0;"></div>
  <div class="contant"></div>

  <div id="footer"></div>
  <script src="/header/header.js"></script>

  <script>
    const params   = new URLSearchParams(window.location.search);
    const imageId  = params.get("id");
    const courseId = params.get("course");

    const imageTitle = document.getElementById("image-title");
    const imageBox   = document.getElementById("image-box");
    const contant    = document.querySelector(".contant");

    const token = localStorage.getItem("token");
    if (!token) {
      window.location.href = "/login/index.html";
    }

    // --- جلب الصورة ---
    async function getContant(courseID, imageId) {
      try {
        const response = await fetch(`${window.location.origin}/${courseID}/${imageId}`, {
          method: "GET",
          headers: {
            "content-Type": "application/json",
            Authorization: `Bearer ${token}`,
          },
        });

        const data = await response.json();
        if (!response.ok) {
          alert(data.msg || "حدث خطأ");
          return;
        }

        if (imageTitle) {
          imageTitle.innerHTML = `${data.contant.title} <i class="fa-solid fa-image" style="color: #ffffff;"></i>`;
        }

        if (!data.contant.url) {
          alert("لا يوجد رابط للصورة");
          return;
        }

        imageBox.innerHTML = `
          <img src="${data.contant.url}" alt="${data.contant.title}" style="max-width:90%; border-radius:12px; box-shadow:0 2px 8px rgba(0,0,0,0.2);" />
        `;
      } catch (error) {
        console.error("Error:", error);
        alert("فشل الاتصال بالسيرفر");
      }
    }

    getContant(courseId, imageId);

    // --- جلب قائمة المحتوى ---
    // ✅ جلب المحتوى (الدروس + المحتويات)
      fetch(`${window.location.origin}/courses/${courseId}/full`,{
        method: "GET",
        headers: {"Authorization": `Bearer ${token}`}
      })
        .then(response => {
          if(response.status === 401) {
            contant.innerHTML = `<button id="popup-subscribe-btn" class="btn btn-primary btn-lg btn-block" onclick="window.location.href='/login/index.html'">سجل الدخول لرؤية المحتوي </button>`;
          }
          if(!response.ok) throw new Error("حدث خطأ أثناء جلب البيانات");
          return response.json();
        })
        .then(data => {
          if(!data.lessons || data.lessons.length === 0) {
            contant.innerHTML = `<h1 style="color:#000"> استني المحتوي هينزل قريب</h1>`;
            return;
          }

          Sup().then(result => {
            contant.innerHTML = ""; // تفريغ

            data.lessons.forEach((lesson,index) => {
              const lessonId = `lesson-${index}`;
              contant.innerHTML += `
              <div class="lesson-block">
                <h3 class="lesson-title" onclick="toggleLesson('${lessonId}')">
                  📘 ${lesson.title}
                  <i class="fa-solid fa-chevron-down"></i>
                </h3>
                <div id="${lessonId}" class="lesson-content" style="display:none;"></div>
              </div>
            `;

              setTimeout(() => {
                const lessonContentDiv = document.getElementById(lessonId);
                lesson.contents.forEach(item => {
                  let icon = item.type === "video" ? "fa-circle-play" :
                    item.type === "pdf" ? "fa-file-lines" :
                      item.type === "image" ? "fa-image" : "fa-question";

                  if(result) {
                    lessonContentDiv.innerHTML += `
                    <div class="contant-div" onclick="window.location.href='/contant/${item.type}.html?course=${courseId}&id=${item._id}'">
                      <p><i class="fa-solid ${icon}" style="color:#0088ff;"></i> | ${item.title}</p>
                    </div>
                  `;
                  } else {
                    lessonContentDiv.innerHTML += `
                    <div class="contant-div" onclick="openPopup()">
                      <p><i class="fa-solid ${icon}" style="color:#0088ff;"></i> | ${item.title}</p>
                    </div>
                  `;
                  }
                });
              },100);
            });
          });
        })
        .catch(err => {
          contant.innerHTML = `<p style="color:red;">${err.message}</p>`;
        });

      // ✅ دالة فتح/غلق الدرس
      function toggleLesson(id) {
        const el = document.getElementById(id);
        el.style.display = (el.style.display === "none" ? "block" : "none");
      }


      document.addEventListener("DOMContentLoaded",() => {
        const titles = document.querySelectorAll(".lesson-title");

        titles.forEach(title => {
          title.addEventListener("click",() => {
            const content = title.nextElementSibling;

            // التبديل بين الفتح والإغلاق
            content.classList.toggle("open");
          });
        });
      });



    

  </script>
</body>
</html>
